- name: Setup new server with Docker & Nginx

  hosts: all

  become: true

  gather_facts: yes

  vars_files:
    - vars/common.yml
    - vars/timezone.yml
    - vars/dnfautomatic.yml

  roles:
    - role: geerlingguy.git
    - role: geerlingguy.docker
    - role: geerlingguy.repo-epel
    - role: geerlingguy.nginx
      vars:
        nginx_proxy_cache_path: "/var/cache/nginx keys_zone=cache:32m"
        nginx_vhosts:
          - listen: "443 ssl http2"
            server_name: "dev.***REMOVED***.com"
            state: "present"
            template: "{{ nginx_vhost_template }}"
            extra_parameters: |
              ssl_certificate /etc/ssl/***REMOVED***.com/***REMOVED***.com.pub;
              ssl_certificate_key /etc/ssl/***REMOVED***.com/***REMOVED***.com.priv;
              ssl_protocols TLSv1.2 TLSv1.3;
              ssl_ciphers HIGH:!aNULL:!MD5;
              location / {
                proxy_pass http://127.0.0.1:8000;
              }
        nginx_service_state: stopped
        nginx_service_enabled: no

    - role: devsec.hardening.os_hardening
      vars:
        sysctl_overwrite:
          # enable IPv4 traffic forwarding for docker
          net.ipv4.ip_forward: 1
    - role: devsec.hardening.ssh_hardening
    - role: devsec.hardening.nginx_hardening

  tasks:
    - import_tasks: tasks/utils.yml
    - import_tasks: tasks/install-btop.yml
    - import_tasks: tasks/prepare-docker.yml
    - import_tasks: tasks/docker-helloworld.yml
    - import_tasks: tasks/start-nginx.yml
    - import_tasks: tasks/dnf-automatic.yml
